# Jabber RSS Transport

Транспорт для Jabber (XMPP), позволяющий получать содержимое RSS-лент в любом Jabber-клиенте. Основан на коде транспорта, использовавшегося когда-то на rss.jrudevels.org (http://wiki.jrudevels.org/Rss.jrudevels.org - разработчик Binary). 

## Требования

* python2.7
* python-pyxmpp
* python-feedparser
* python-mysqldb

Проверялась работа на Debian 11 с установленными из репозитория Debian 10 зависимостями (pyxmpp 1.1.2-1, feedparser 5.2.1-1 и mysqldb 1.3.10-2). При невозможности установки из репозитория библиотеки можно скачать отдельно и разместить в каталоге транспорта. Фактически, минимально требуется только наличие python2 - из-за того, что разработка основной зависимости - pyxmpp - прекращена, а pyxmpp2 по состоянию на 2022 год не готов, запуск транспорта на python3 пока проблематичен.

## Изменения по сравнению с версией 2007 года, полученной от Binary

* Скрипт перевел с PosgreSQL на MySQL
* Восстановил схему базы.
* Убрал ILIKE - в мускуле его нет. Case insensitive решается на стороне базы (есть в схеме) 
* Заменил внутренности dbQuote на escape_string.
* Поиск можно делать по всему, в том числе по URL'у
* Добавлена обработка в том числе HTTPS-лент - то, из-за чего раньше не удавалось их регистрировать
* Привел в порядок тему с encode()
** Названия лент и описания можно делать на русском или любом другом языке.
* Есть возможность настраивать интервал обновления при регистрации ленты
* Сделаны нормальные визитки для лент, в которых есть адрес ленты и интервал обновления. Добавил RSS-лого в качестве фото для транспорта и ботов.
* Конфиг вынесен в отдельный файл
* Добавлено преобразование ряда HTML-тегов в соответствующие символы
* Добавлено удаление ссылок из тела ленты при вычислении хэша - на некоторых лентах это приводило к постоянным изменениям ленты (апдейт SID или alt-текста о числе просмотра картинок на форумах).
* Сделал реконнект для базы
* Сделал таймаут для получения лент

## Установка

* Разместить файлы транспорта в любом удобном каталоге.
* Создать в MySQL или MariaDB базу (проверялась работа на MariaDB 10.5.15)
* Импортировать в созданную базу схему из jrdrss.scheme.sql
* Добавить в конфиг-файл Jabber-сервера описание транспорта. На примере ejabberd:

** Старый формат:
     {5555, ejabberd_service, [
                              {ip, {127.0.0.1}},
                              {access, all},
                              {shaper_rule, fast},
                              {host, "rss.domain.com", [{password, "superpassword"}]}
                              ]},

** Новый формат:
    -
      port: 5555
      ip: "127.0.0.1"
      module: ejabberd_service
      access: all
      hosts:
       "rss.domain.com":
         password: "superpassword"
      shaper_rule: fast

* В файле config.xml транспорта прописать используемые параметры подключения - к mysql (хост, юзер, пароль и название базы) и к Jabber-серверу (название транспорта, IP, порт, пароль).
* Тем или иным способом запустить jrdrss.py (в идеале от отдельного пользователя) - можно в GNU screen или с помощью идущего в комплекте jrdrss.service-файла для systemd. Последний можно разместить в ~/.config/systemd/user/jrdrss.service, далее выполнить:
** systemctl --user enable jrdrss.service
** systemctl --user start jrdrss.service
* Для автостарта пользовательского service-файла использовать команду:
** loginctl enable-linger username
* ...либо все то же самое, но глобально, а в jrdrss.service указать нужные имя и группу пользователя.

## Использование

Открыть браузер сервисов, найти транспорт. Можно либо использовать поиск в контекстном меню транспорта, чтобы найти интересующую ленту (из уже зарегистрированных), либо зарегистрировать новую. В последнем случае нужно ввести название ленты (короткое, без пробелов; в идеале - но не обязательно - латинницей), адрес ленты, описание и выбрать интервал обновления (по умолчанию - 1 час, но для активных лент можно задать интервал вплоть до 1 минуты). После чего в список контактов будет добавлен бот вида "имя_ленты@rss.domain.com", которого надо авторизовать и который и будет присылать новости. Чтобы отписаться от ленты - просто удаляем бота.

----

JabberWorld