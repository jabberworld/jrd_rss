## Изменения в версии 1.0 по сравнению с версией 2007 года, полученной от Binary

* Скрипт перевел с PostgreSQL на MySQL
* Восстановил схему базы и расширил под новые требования.
* Убрал ILIKE - в мускуле его нет. Case insensitive решается на стороне базы (есть в схеме)
* Заменил внутренности dbQuote на escape_string.
* Поиск можно делать по всему, в том числе по URL'у
* Добавлена обработка в том числе HTTPS-лент - то, из-за чего раньше не удавалось их регистрировать
* Привел в порядок тему с encode()
* Названия лент и описания можно делать на русском или любом другом языке.
* Есть возможность настраивать интервал обновления при регистрации ленты
* Сделаны нормальные визитки для лент, в которых есть адрес ленты и интервал обновления. Добавил RSS-лого в качестве фото для транспорта и ботов.
* Конфиг вынесен в отдельный файл
* Добавлено преобразование ряда HTML-тегов в соответствующие символы
* Добавлено удаление ссылок из тела ленты при вычислении хэша - на некоторых лентах это приводило к постоянным изменениям ленты (апдейт SID или alt-текста о числе просмотра картинок на форумах).
* Сделал реконнект для базы
* Сделал таймаут для получения лент

## v 1.1

* Список всех лент с описаниями теперь можно посмотреть в браузере сервисов.
* Изменена логика хранения данных о полученных статьях: если раньше при активном изменении ленты (например, автор правит посты, они то появляются, то исчезают из ленты) могли приходить уведомления на каждое такое изменение, то сейчас информация сохраняется на более длительный период (до 3 дней).
* md5 для статьи строится теперь только по заголовку+ссылке, а не по всему телу целиком. Иначе говоря, если автор ленты поправил опечатку или поставил запятую - это теперь не считается новым постом.
* Почистил ненужные зависимости (часть из которых стала нужными только при реализации списка лент в браузере сервисов).

Для обновления существующей установки в MySQL выполнить
```
ALTER TABLE sent MODIFY COLUMN received BOOLEAN DEFAULT FALSE ;
```
## v 1.1.1

* Основное изменение - добавлены отдельные треды для работы с базой. Раньше транспорт мог вылетать, если запросы из разных подпроцессов (например, работа с обновлением ленты и работа со статусами) накладывались друг на друга. Сейчас это исключено; фактически активны обычно 2 подключения (обновление ленты и статусы), на активно используемых транспортах может быть до 4 - добавляются подключения для поиска и регистрации лент.

## v 1.1.2

* Косметические изменения: изменен формат передачи данных в SQL-запросы согласно https://stackoverflow.com/questions/775296/mysql-parameterized-queries, удалена функция dbQuote.

## v 1.1.3

* Украшательства: теперь в статусе бота отображается описание ленты, время последнего обновления, число сообщений с последнего обновления и число подписчиков. Бот ставит статус "Готов поболтать" в случае прихода новых сообщений и "Недоступен" в случае проблемы получения ленты.

## v 1.1.4

* Изменен стиль установки статуса: число сообщений с последнего обновления не особо информативны, поэтому вместо этого добавлена статистика числа сообщений за последние сутки. Статус тоже ставится исходя из этой статистики - для "болтливой" ленты будет статус "Готов поболтать" (и такие контакты зачастую отображаются наверху ростера); для недоступной, как и раньше, ставится "Недоступен".

## v 1.1.5

* Исправлен выявленный баг со сбросом статуса ботов при получении статуса "Онлайн" от клиента пользователя. Статус "Готов поболтать" ставится теперь только в случае, если были сообщения за последний час; если сообщений не было больше суток - ставится "Away".

## v 1.2

* Добавлена новая функция - "Приватные ленты". При регистрации для ленты можно установить галочку "Private" - такая лента не отображается в поиске и в браузере сервисов. Функция требует добавления новой колонки в базе - см. каталог alts

## v 1.3

* Приватные ленты теперь видимы в поиске и браузере сервисов для того, кто их создал. В базу добавлено поле registrar - см. каталог alts

## v 1.3.1

* Добавлены 2 дополнительные ноды в браузере сервисов: "I am registrar" (ленты, которые регистрировал данный пользователь) и "My private feeds" (Приватные ленты пользователя).

## v 1.4

* Добавлена система тегов для лент. При регистрации ленты можно указывать теги через запятую. Далее в браузере сервисов в разделе "Categories" транспорта можно искать интересующую ленту по темам. В базе добавлено дополнительное поле для тегов, см. каталог alts.

## v 1.4.1

* Bugfix release

## v 1.4.2

* Добавлен адаптивный режим обновления лент: при включении опции adaptive в конфиге время обновления подстраивается под частоту сообщений от ленты за последний час, но не чаще 1 раза в минуту и не реже времени, заданного при регистрации. Т.е., теперь вполне можно оставлять время при регистрации по умолчанию в 1 час, а дальше уже будет работать автоподстройка

## v 1.4.3

* Переработка кода: для подключения к базе форсирован юникод (кроме того, такой режим - дефолт для Python3, что облегчит миграцию в дальнейшем), запросы из базы теперь возвращают юникод. PyXMPP тоже в основном работает с юникодом - в итоге все, что касается unicode()/encode() сдвинуто в сторону юникодных объектов. Возможны ошибки в работе, хотя постарался пройти по всем функциям в разных сочетаниях.

## v 1.4.4

* Упрощен код подписок на ленты - убран лишний sql-запрос в секции регистрации ленты - он дублирует такой же в секции работы с подписками и, возможно, в некоторых ситуациях эти запросы шли параллельно, что приводило к двойной подписке на ленту и дублировании сообщений от нее. Убран дублирующийся запрос в секции работы с подписками.

## v 1.4.5

* Добавлено отображение реального времени обновления в адаптивном режиме в vCard ленты и добавлено отображение времени следующего обновления (с учетом адаптивности) в статусе ботов.

## v 1.4.6

* Добавлена функция отключения регистрации лент для всех, кроме админов, перечисленных в config.xml

## v 1.5

* Работа с сообщениями от админа. Через любую ленту или напрямую через транспорт можно отправить следующие команды:
```
    updateall - обновить все ленты
    update NAME - обновить ленту NAME
    purgelast NAME - удалить последнюю запись для ленты NAME. Иначе говоря, при следующем обновлении считать, что данная новость непрочитана (и она будет доставлена всем пользователям повторно)
    purgeall NAME - удалить все записи для ленты NAME.
    settags NAME TAG1,TAG2,TAG3... - установить теги для ленты NAME
    setupd NAME 3600 - установить период обновления ленты NAME в 3600 секунд (нельзя поставить ниже 60 секунд)
    setdesc NAME Description for feed - установить описание ленты NAME
    + NAME URL INTERVAL DESCRIPTION [SETTAGS: TAG1,TAG2,TAG3] - добавить в базу ленту NAME с адресом URL, периодом обновления INTERVAL и описанием DESCRIPTION. При необходимости можно указать теги, следующие за ключевым словом SETTAGS:
```
* Полный список доступных команд можно посмотреть по команде help

## v 1.6

* Фильтры для сообщений! Теперь пользователь может задать белые и черные списки для тем сообщений. Соответственно, если есть что-то в белом списке - приходят сообщения ТОЛЬКО подходящие под данный фильтр - используйте с осторожностью. Ну и наоборот - все сообщения, которые подходят под негативный фильтр, приходить перестанут.
* Добавлены 3 новых команды: ``showfilter``, ``setposfilter``, ``setnegfilter``
* В базе добавлены 2 новых колонки - см. каталог alts

## v 1.7

* Некоторые ленты отдают статью в полном размере в теле сообщения, что может быть неудобно для чтения. Для таких лент теперь можно задать максимальный размер сообщения с помощью команды ``setshort`` - см. справку по команде ``help``.
* Схема базы обновлена, см. каталог alts.

## v 1.7.1

* Добавлены команды ``hide`` / ``unhide`` - возможность для владельца ленты менять флаг приватности и ее видимость в браузере сервисов и в поиске для других пользователей. Также небольшие фиксы для ``settags`` и ``setdesc`` - раньше в ответ возвращалось сообщение об успешном изменении параметра для любой ленты, даже если пользователь не являлся ее владельцем (реального изменения при этом не было).

## v 1.7.2

* По просьбам телезрителей добавлена возможность вставки favicon.ico с сайта в качестве фото в vCard ленты. В конфиге добавилась новая опция для этого. Берется исключительно /favicon.ico, страница не парсится. Если лого недоступно - используется дефолтное лого для RSS. Для использования функции надо поставить python-pil

## v 1.7.3

* Добавил парсер страницы через python-lxml, теперь favicon не обязательно должен быть в /favicon.ico

## v 1.7.4

* Исправления для алгоритма получения favicon.ico. Теперь в приоритете стандартный путь и если по нему ничего нет - то уже тогда парсим страницу.

## v 1.7.5

* Bugfix release: fix for empty messages

## v 1.7.6

* Fix for iq:last. Now you can get uptime for transport and last activity for feed. Added XMPP Ping and XMPP URN Time.

## v 1.7.7

* Real fix for empty messages

## v 1.7.8

* Added resource to JIDs

## v 1.7.9

* Добавлена возможность вывода новостей без описания - только заголовок и ссылка. Для этого установите размер описания равным 1 командой ``setshort NAME 1``

## v 1.8

* Название ленты для ``update``, ``purgelast``, ``purgeall``, ``hide`` и ``unhide`` сделано опциональным - теперь при отсутствии названия параметр применяется к текущей ленте.

## v 1.8.1

* Добавил возможность редактирования через команды ``settags``, ``setdesc``, ``setupd``, ``hide`` и ``unhide`` и для администраторских аккаунтов, а не только для владельцев лент.

## v 1.8.2

* Добавил специальное ключевое слово ``:`` для всех команд, где название ленты может трактоваться неоднозначно. Ключевое слово ``:`` указывает на ту ленту, которой отправляется команда. Т.е., теперь можно писать, например, ``setdesc : Описание ленты`` для того, чтобы установить описание текущей ленте.

## v 1.8.3

* Фикс на случай отправки сообщений с ``:`` напрямую транспорту.

## v 1.8.4

* Убраны SQL-запросы для проверки наличия ленты и URL.

## v 1.8.5

* Добавлен режим "сокращенного" тела ленты - по ``setshort NAME 2`` показывается только первое предложение.

## v 1.8.6

* Bugfix release.

## v 1.9

* Добавлен архив сообщений: теперь можно отправить ленте число от 1 до 9 для получения последних сообщений. Обновилась схема базы - см. alts.

## v 1.9.1

* Fix for utf8mb4 symbols in feed content

## v 1.10

* Добавлена возможность поиска по архиву новостей с помощью команд ``search`` (в той ленте, которой отправлена команда) и ``searchall`` для поиска по всем лентам. Результаты лимитированы 10 записями.

## v 1.11

* Теперь в конфигурационном файле можно задать размер архива сообщений, размер должен находиться в диапазоне от 3 до 365 дней. Также добавлены алиасы для команд поиска, появившихся в прошлой версии - ``?`` и ``?!``.

## v 1.11.1

* Добавлен также алиас для команды ``help`` - ``?`` без аргументов.

## v 1.11.2

* Добавлен ряд новых коротких алиасов для команд. Принцип именования простой: то, что можно установить (команды, начинающиеся на set) - начинаются с **=**; там, где можно что-то посмотреть или узнать - начинаются с **?** (как в случае с поиском или ``help`` ранее).

Список новых алиасов:
* **``=#``** (как привычный многим хэштег, ага) - установить теги. Т.е., теперь можно дать команду ```=# : Новости,Технологии``` для того, чтобы установить указанные теги для текущей ленты.
* **``=@``** (@ - at, т.е., когда) - указываем период обновления ленты
* **``=:``** (двоеточие - как пояснение чего-то) - указываем описание ленты
* **``=...``** - аналог setshort - сокращенный вывод ленты (в сокращенном виде не влазящий текст заменяется многоточием). Т.е., можно скомандовать ``=... : 1``, чтобы включить title only текущей ленте.
* **``=+``** - фильтр белого списка
* **``=-``** - фильтр черного списка
* **``***``** - спрятать ленту (сделать приватной)
* **``+++``** - сделать ленту публичной
* **``?+-``** - показать фильтры
* **``?***``** - показать мои приватные ленты
* **``?~``** (~ как символ home) - показать мои ленты

* Также исправлена опечатка, из-за чего не работала команда hide.

## v 1.11.3

* Добавлены команды для показа тегов, описания, интервала (установленного и адаптивного) и размера сообщения.
